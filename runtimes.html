<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stump the Buff - v3.2</title>
  <style>
    /* ---------- GLOBAL / LAYOUT ---------- */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: black;
      color: white;
      font-family: Rockwell, serif;
    }
    .page-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      box-sizing: border-box;
      text-align: center;
    }
    h1, h2, h3, p {
      margin: 0 0 10px 0;
    }
    button {
      cursor: pointer;
    }
    .version-number {
      text-align: center;
      font-size: 10px;
      opacity: 0.7;
      margin-top: 20px;
    }

    /* ---------- BUTTON STYLES ---------- */
    .diff-btn {
      background: #222;
      border: 2px solid #FFD700;
      color: white;
      font-size: 16px;
      padding: 8px 16px;
      margin: 5px;
      transition: background 0.2s, color 0.2s, border-color 0.2s;
    }
    .diff-btn:hover {
      background: #333;
    }
    .diff-btn.active {
      background: #FFD700;
      color: black;
      border-color: #FFD700;
    }
    #begin-btn {
      background: #FFD700;
      color: black;
      border: none;
      font-size: 22px;
      padding: 12px 30px;
      margin-top: 20px;
    }
    #begin-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ---------- MAIN CONTAINERS ---------- */
    #intro-container {
      display: flex;
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
    }
    #game-container,
    #bonus-container,
    #final-container {
      display: none;
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
    }

    /* ---------- INTRO PAGE ---------- */
    #intro-container .intro-rules {
      max-width: 600px;
      font-size: 16px;
      line-height: 1.4;
      margin-bottom: 20px;
      text-align: center;
    }
    .difficulty-box { margin-bottom: 20px; }

    /* ---------- GAME PAGE ---------- */
    #timer-box {
      margin: 10px auto;
      width: 160px;
      height: 160px;
      background-color: #222;
      border-radius: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 64px;
      font-weight: bold;
      color: white;
      border: 2px solid #444;
      transition: all 0.2s ease;
    }
    #submit-btn {
      font-size: 22px;
      padding: 12px 30px;
      margin: 20px auto;
      background: #FFD700;
      color: black;
      border: none;
    }
    #submit-btn:hover {
      background: #FFC700;
    }
    #runtimes-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    /* 
       --- Changed this from a grid to a flex layout so that the movie cards 
           are more obviously centered regardless of screen size. 
    */
    #movies-container {
      display: flex; /* was grid before */
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
      width: 100%;
    }

    .movie-card {
      width: 240px;
      border: 2px solid white;
      padding: 20px;
      background-color: #000;
      border-radius: 30px;
      text-align: center;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: background-color 0.2s, border-color 0.2s;
    }
    .movie-title {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 28px;
    }
    .placed {
      border-color: #FFD700 !important;
      background-color: #111;
    }
    .runtime-card {
      width: 100px;
      height: 60px;
      border-radius: 30px;
      background-color: #FFD700;
      color: black;
      font-weight: bold;
      border: 2px solid #FFD700;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 5px;
      cursor: grab;
      animation: float-run 3s ease-in-out infinite alternate;
    }

    /*
       --- Changed these from green (#00FF00) to neon yellow (#fffd00).
    */
    .runtime-card.dragging {
      outline: 3px solid #fffd00;
      box-shadow: 0 0 10px #fffd00;
    }

    @keyframes float-run {
      0% { transform: translateY(0); }
      100% { transform: translateY(-5px); }
    }
    .correct {
      background-color: #003300 !important;
      border-color: #00FF00 !important;
      animation: bounce-correct 0.5s;
    }
    .incorrect {
      background-color: #330000 !important;
      border-color: #FF0000 !important;
      animation: shake-red 0.5s;
    }
    @keyframes bounce-correct {
      0% { transform: scale(1); }
      30% { transform: scale(1.1); }
      50% { transform: scale(0.95); }
      100% { transform: scale(1); }
    }
    @keyframes shake-red {
      20% { transform: translateX(-3px); }
      40% { transform: translateX(3px); }
      60% { transform: translateX(-3px); }
      80% { transform: translateX(3px); }
    }
    .stats-box {
      border: 1px solid #666;
      padding: 10px;
      margin: 10px auto;
      width: fit-content;
      min-width: 200px;
    }
    .stats-box.empty { display: none; }

    #joker-btn {
      display: inline-block;
      width: 80px;
      height: 80px;
      border-radius: 40px;
      font-size: 32px;
      background: #222;
      border: 2px solid #FFD700;
      color: white;
      margin: 10px auto;
    }
    #joker-btn:hover {
      background: #333;
    }
    .glow-anim {
      animation: glow 2s ease-in-out infinite alternate;
    }
    @keyframes glow {
      0% { box-shadow: 0 0 5px #FFD700; }
      100% { box-shadow: 0 0 20px #FFD700; }
    }

    /* ---------- BONUS ROUND (Grid) ---------- */
    #bonus-container {
      text-align: center;
    }
    #bonus-timer-box {
      margin: 10px auto;
      width: 120px;
      height: 120px;
      background-color: #222;
      border-radius: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      font-weight: bold;
      color: white;
      border: 2px solid #444;
      transition: all 0.2s ease;
      margin-bottom: 20px;
    }
    #bonus-floating-container {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      width: 100%;
      max-width: 800px;
      margin: 0 auto 20px auto;
    }
    .floating-card {
      width: 120px;
      height: 120px;
      border: 2px solid white;
      border-radius: 60px;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      padding: 5px;
    }

    /* ---------- FINAL PAGE ---------- */
    #final-container {
      text-align: center;
    }
    #final-scores {
      margin-bottom: 20px;
      font-size: 28px;
      font-weight: bold;
    }
    #details-toggle {
      margin-bottom: 10px;
      padding: 8px 16px;
      font-size: 14px;
      background: #222;
      color: white;
      border: 2px solid #FFD700;
      cursor: pointer;
    }
    #details-container {
      display: none;
      margin: 10px 0;
    }
    .breakdown-row {
      margin-bottom: 10px;
      text-align: center;
    }

    /*
       --- Now we use a grid with 3 columns, which will automatically
           wrap to 2 in the next row if there are 5 items.
    */
    .final-round-row {
      display: grid; 
      grid-template-columns: repeat(3, 140px); 
      grid-auto-rows: auto;
      gap: 10px;
      justify-content: center;
      margin-bottom: 15px;
      flex-wrap: wrap; /* leftover from the old approach, won't hurt */
    }

    .final-round-heading {
      font-size: 32px;
      text-align: center;
      width: 100%;
      font-weight: bold;
      margin-bottom: 8px;
      grid-column: 1 / -1; /* makes the heading span full width */
    }
    .final-card {
      border-radius: 10px;
      border: 2px solid #666;
      padding: 10px;
      text-align: center;
      width: 140px;
      background: #000;
      margin: 5px;
    }
    .final-card.correct {
      background-color: #003300;
      border-color: #0f0;
    }
    .final-card.incorrect {
      background-color: #330000;
      border-color: #f00;
    }

    /* ---------- MINI-RECAP (per-round) ---------- */
    #round-recap-overlay {
      display: none;
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9);
      padding: 20px;
      border: 3px solid #FFD700;
      border-radius: 10px;
      text-align: center;
      z-index: 9999;
      width: 300px;
    }
    #round-recap-overlay h3 {
      margin-top: 0;
      margin-bottom: 10px;
    }
    #round-recap-overlay p {
      margin-bottom: 10px;
    }
    #round-recap-overlay button {
      background: #222;
      border: 2px solid #FFD700;
      color: white;
      font-size: 16px;
      padding: 6px 12px;
      cursor: pointer;
    }

    /* ---------- SOUND EFFECTS ---------- */
    audio { display: none; }
  </style>
</head>
<body>
  <!-- SOUND EFFECTS -->
  <audio id="ding-sound" src="data:audio/wav;base64,UklGRgAAAABXQVZFZm10IBIAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA="></audio>
  <audio id="buzz-sound" src="data:audio/wav;base64,UklGRgAAAABXQVZFZm10IBIAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA="></audio>
  <!-- AUDIO FOR JOKER -->
  <audio id="joker-sound" preload="auto">
    <source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA=" type="audio/wav">
  </audio>

  <!-- INTRO SCREEN -->
  <div id="intro-container" class="page-container">
    <h1>Stump the Buff</h1>
    <div class="intro-rules">
      <p>In this game, you'll be given 5 movies each round.</p>
      <p>Drag the runtime card to the movie you think it belongs to.</p>
      <p>You have a limited time each round and can submit early for a time bonus.</p>
      <p>Use your <strong>Joker</strong> once at the start of the round.</p>
    </div>
    <div class="difficulty-box">
      <label style="font-size:16px; margin-right:10px;">Difficulty:</label>
      <button class="diff-btn" data-difficulty="easy" id="easy-btn">Easy</button>
      <button class="diff-btn" data-difficulty="medium" id="medium-btn">Medium</button>
      <button class="diff-btn" data-difficulty="hard" id="hard-btn">Hard</button>
    </div>
    <button id="begin-btn" disabled>Begin</button>
    <div class="version-number">v3.2</div>
  </div>

  <!-- ROUND RECAP OVERLAY -->
  <div id="round-recap-overlay">
    <h3 id="round-recap-title"></h3>
    <p id="round-recap-details"></p>
    <button id="round-recap-close-btn">OK</button>
  </div>

  <!-- GAME SCREEN -->
  <div id="game-container" class="page-container">
    <div id="timer-box"><span id="timer-value">20</span></div>
    <button id="submit-btn" title="Submit early to earn extra time bonus!">Submit</button>
    <div id="runtimes-container" class="cards-container"></div>
    <div id="movies-container" class="cards-container"></div>
    <div class="center">
      <button id="joker-btn" class="glow-anim" title="Reveal relative runtimes briefly">🤡</button>
    </div>
    <div id="this-game-stats" class="stats-box empty"></div>
  </div>

  <!-- BONUS ROUND (Grid Layout) -->
  <div id="bonus-container" class="page-container">
    <div id="bonus-timer-box"><span id="bonus-timer-value">10</span></div>
    <h3 id="bonus-message"></h3>
    <div id="bonus-floating-container" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; width:100%; max-width:800px; margin:0 auto 20px auto;"></div>
    <div id="bonus-result"></div>
    <button id="bonus-continue-btn">Continue</button>
  </div>

  <!-- FINAL SCREEN -->
  <div id="final-container" class="page-container">
    <div id="final-scores"></div>
    <button id="details-toggle">Show/Hide Details</button>
    <div id="details-container">
      <div id="round-breakdown"></div>
      <div id="final-cards-container"></div>
    </div>
    <div>
      <button id="share-twitter-btn">Share on Twitter</button>
      <button id="copy-recap-btn">Copy Recap</button>
      <button id="play-again-btn">Play Again?</button>
    </div>
  </div>

  <script>
    /*******************************************************
     * GLOBAL STATE & CONFIG
     *******************************************************/
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vToIbm5XR9mtqOXHYzpF0jIXhGY9WI9m-QQak2KsZFB6CGVnRVRCPL3V6zFVbT6e_jLyGQM1e5XPjcX/pub?gid=131639577&single=true&output=csv";
    let difficulty;
    let allMovies = [];
    let filteredMovies = [];
    const TIMERS = {
      easy:   [30, 30, 30, 30, 30],
      medium: [30, 25, 20, 15, 15],
      hard:   [20, 18, 15, 12, 10]
    };
    let roundTimers = [];
    let rounds = [];
    let currentRoundIndex = 0;

    let totalCorrect = 0;
    let totalDifference = 0;
    let totalAnswered = 0;
    let totalScore = 0;
    let roundScores = [];

    let jokerUsed = false;
    let timeLeft = 20;
    let roundTimer = null;
    let canDrag = false;

    // Bonus
    let bonusMovies = [];
    let bonusUsed = false;
    let bonusTimer = null;
    let bonusTimeLeft = 10;

    document.addEventListener("DOMContentLoaded", async () => {
      document.getElementById("easy-btn").addEventListener("click", () => setDifficulty("easy"));
      document.getElementById("medium-btn").addEventListener("click", () => setDifficulty("medium"));
      document.getElementById("hard-btn").addEventListener("click", () => setDifficulty("hard"));
      setDifficulty("easy");

      const beginBtn = document.getElementById("begin-btn");
      beginBtn.disabled = true;
      beginBtn.innerText = "Loading...";
      try {
        await fetchCSV();
        console.log("Parsed movies:", allMovies);
        beginBtn.disabled = false;
        beginBtn.innerText = "Begin";
      } catch(e) {
        console.error("Error fetching CSV:", e);
        beginBtn.innerText = "Error loading data";
      }

      beginBtn.addEventListener("click", onBeginGame);

      document.getElementById("joker-btn").addEventListener("click", () => {
        if (!jokerUsed) useJoker();
      });
      document.getElementById("submit-btn").addEventListener("click", onSubmitRound);

      document.getElementById("bonus-continue-btn").addEventListener("click", onFinishBonus);
      document.getElementById("share-twitter-btn").addEventListener("click", shareOnTwitter);
      document.getElementById("copy-recap-btn").addEventListener("click", copyRecap);
      document.getElementById("play-again-btn").addEventListener("click", () => {
        document.getElementById("final-container").style.display = "none";
        document.getElementById("intro-container").style.display = "flex";
      });
      document.getElementById("details-toggle").addEventListener("click", () => {
        const det = document.getElementById("details-container");
        det.style.display = (det.style.display === "none" ? "block" : "none");
      });

      document.getElementById("round-recap-close-btn").addEventListener("click", () => {
        document.getElementById("round-recap-overlay").style.display = "none";
        nextRoundAfterRecap();
      });
    });

    /*******************************************************
     * CSV PARSING (with BOM removal)
     *******************************************************/
    async function fetchCSV() {
      const resp = await fetch(csvUrl);
      let data = await resp.text();
      // Remove BOM if present
      data = data.replace(/^\uFEFF/, "");
      parseCSV(data);
    }
    function parseCSV(csvData) {
      const lines = csvData.trim().split(/\r?\n/);
      const headers = lines[0].split(",");
      const colMovieName = headers.indexOf("Movie Name");
      const colRuntimeMin = headers.indexOf("runtime_minutes");
      const colRuntime = headers.indexOf("Runtime");
      const colVotesRank = headers.indexOf("Votes Percent Rank");

      for (let i = 1; i < lines.length; i++) {
        const rowCells = lines[i].split(",");
        if (rowCells.length < 4) continue;
        let movie = {};
        movie["Movie Name"] = rowCells[colMovieName]?.trim() || "";
        movie.runtime_minutes = parseInt(rowCells[colRuntimeMin] || "0", 10);
        movie.Runtime = rowCells[colRuntime]?.trim() || "";
        movie._rank = parseFloat(rowCells[colVotesRank] || "0");
        movie._assignedRuntime = null;
        allMovies.push(movie);
      }
    }

    function setDifficulty(diff) {
      difficulty = diff;
      ["easy-btn","medium-btn","hard-btn"].forEach(id => {
        document.getElementById(id).classList.remove("active");
      });
      document.getElementById(`${diff}-btn`).classList.add("active");
    }

    function onBeginGame() {
      if (!difficulty) difficulty="easy";
      document.getElementById("intro-container").style.display="none";
      document.getElementById("game-container").style.display="flex";
      setupGame();
    }
    function setupGame() {
      currentRoundIndex=0;
      totalCorrect=0;
      totalDifference=0;
      totalAnswered=0;
      totalScore=0;
      roundScores=[];
      jokerUsed=false;
      bonusUsed=false;

      document.getElementById("bonus-container").style.display="none";
      document.getElementById("final-container").style.display="none";

      filterByDifficulty();
      if(filteredMovies.length<25){
        filteredMovies=allMovies.slice();
      }
      roundTimers=TIMERS[difficulty]||[20,20,20,20,20];
      buildRounds();
      startRound();
    }
    function filterByDifficulty() {
      if(!difficulty)return;
      if(difficulty==="easy"){
        filteredMovies=allMovies.filter(m=>m._rank>0.75);
      }else if(difficulty==="medium"){
        filteredMovies=allMovies.filter(m=>m._rank>=0.5&&m._rank<=0.75);
      }else{
        filteredMovies=allMovies.filter(m=>m._rank<0.5);
      }
    }
    function buildRounds(){
      rounds=[];
      let pool=shuffle(filteredMovies.slice());
      if(pool.length<25){
        for(let i=0;i<5;i++){
          rounds.push(pool.slice(i*5,i*5+5));
        }
      }else{
        const selected=pool.slice(0,25);
        for(let i=0;i<5;i++){
          rounds.push(selected.slice(i*5,(i+1)*5));
        }
      }
      console.log("Rounds built:", rounds);
    }

    function startRound(){
      if(currentRoundIndex>=5){
        document.getElementById("game-container").style.display="none";
        document.getElementById("bonus-container").style.display="flex";
        startBonusRound();
        return;
      }
      fadeOutCards(()=>{
        renderRound();
        fadeInCards();
      });
    }
    function renderRound(){
      timeLeft=roundTimers[currentRoundIndex]||20;
      setupTimer();
      updateGameStatsBox();

      const moviesContainer=document.getElementById("movies-container");
      const runtimesContainer=document.getElementById("runtimes-container");
      moviesContainer.innerHTML="";
      runtimesContainer.innerHTML="";

      document.getElementById("joker-btn").style.display=jokerUsed?"none":"inline-block";

      const roundMovies=rounds[currentRoundIndex];
      roundMovies.forEach(m=>{
        const card=document.createElement("div");
        card.classList.add("movie-card");
        card.setAttribute("data-correct",m.runtime_minutes);
        card.innerHTML=`<div class="movie-title">${m["Movie Name"]}</div>`;
        card.addEventListener("dragover",e=>{if(canDrag)e.preventDefault();});
        card.addEventListener("drop",e=>dropHandler(e,m,card));
        moviesContainer.appendChild(card);
      });

      const roundRuntimes=roundMovies.map((m,i)=>({
        runtime:m.Runtime,
        runtime_minutes:m.runtime_minutes,
        uniqueId:`rt-${currentRoundIndex}-${i}`
      }));
      shuffle(roundRuntimes);
      roundRuntimes.forEach(rt=>{
        const rc=document.createElement("div");
        rc.classList.add("runtime-card");
        rc.setAttribute("data-unique",rt.uniqueId);
        rc.setAttribute("data-runtime",rt.runtime_minutes.toString());
        rc.innerText=rt.runtime;
        rc.setAttribute("draggable","true");
        rc.addEventListener("dragstart",e=>{
          if(!canDrag){e.preventDefault();return;}
          rc.classList.add("dragging");
          e.dataTransfer.setData("text/plain",rt.uniqueId);
        });
        rc.addEventListener("dragend",e=>{
          rc.classList.remove("dragging");
        });
        runtimesContainer.appendChild(rc);
      });
      canDrag=true;
    }

    function setupTimer(){
      clearInterval(roundTimer);
      styleTimerBox(timeLeft);
      const timerVal=document.getElementById("timer-value");
      timerVal.innerText=timeLeft;

      roundTimer=setInterval(()=>{
        timeLeft--;
        timerVal.innerText=timeLeft;
        styleTimerBox(timeLeft);
        if(timeLeft<=0){
          clearInterval(roundTimer);
          onSubmitRound();
        }
      },1000);
    }
    function styleTimerBox(t){
      const timerBox=document.getElementById("timer-box");
      if(t<=3){
        timerBox.style.color="red";
        timerBox.style.borderColor="red";
      }else if(t<=5){
        timerBox.style.color="orange";
        timerBox.style.borderColor="orange";
      }else if(t<=10){
        timerBox.style.color="yellow";
        timerBox.style.borderColor="yellow";
      }else{
        timerBox.style.color="white";
        timerBox.style.borderColor="#444";
      }
    }

    function dropHandler(e,movieObj,movieCard){
      if(!canDrag)return;
      e.preventDefault();
      const uniqueId=e.dataTransfer.getData("text/plain");
      const dragged=document.querySelector(`.runtime-card[data-unique="${uniqueId}"]`);
      if(!dragged)return;

      const rc=document.getElementById("runtimes-container");
      const existing=movieCard.querySelector(".runtime-card");
      if(existing)rc.appendChild(existing);

      movieCard.appendChild(dragged);
      movieCard.classList.add("placed");
      movieObj._assignedRuntime=parseInt(dragged.getAttribute("data-runtime"),10);
    }

    function onSubmitRound(){
      clearInterval(roundTimer);
      canDrag=false;
      document.getElementById("submit-btn").style.display="none";

      const roundMovies=rounds[currentRoundIndex];
      let roundCorrect=0;
      let roundDiff=0;
      let answeredCount=0;
      let sumActual=0;

      const cards=document.getElementById("movies-container").children;
      for(let i=0;i<cards.length;i++){
        const card=cards[i];
        const correctRuntime=parseInt(card.getAttribute("data-correct"),10);
        sumActual+=correctRuntime;
        const assigned=card.querySelector(".runtime-card");
        if(assigned){
          answeredCount++;
          const userRuntime=parseInt(assigned.getAttribute("data-runtime"),10);
          if(userRuntime===correctRuntime){
            roundCorrect++;
            card.classList.add("correct");
          }else{
            card.classList.add("incorrect");
            showCorrectLine(card,correctRuntime);
          }
        }else{
          card.classList.add("incorrect");
          showCorrectLine(card,correctRuntime);
        }
      }

      // leftover time bonus
      const leftoverBonus=timeLeft*10;

      // sum difference
      roundMovies.forEach(m=>{
        if(m._assignedRuntime!=null){
          roundDiff+=Math.abs(m._assignedRuntime-m.runtime_minutes);
        }
      });

      let fractionBonus=0;
      if(answeredCount===5){
        const avgActual=sumActual/5;
        const avgDiff=roundDiff/answeredCount;
        const fraction=avgDiff/avgActual;
        fractionBonus=(1000*roundCorrect)*Math.pow((1-fraction),2);
      }

      const baseScore=roundCorrect*1000;
      const roundScore=baseScore+leftoverBonus+fractionBonus;

      totalCorrect+=roundCorrect;
      totalDifference+=roundDiff;
      totalAnswered+=answeredCount;
      totalScore+=roundScore;

      roundScores.push({
        roundIndex: currentRoundIndex+1,
        correct:roundCorrect,
        diff:roundDiff,
        answered:answeredCount,
        leftoverBonus,
        fractionBonus,
        roundScore
      });

      showRoundRecapOverlay(roundCorrect,answeredCount,leftoverBonus,fractionBonus,roundScore);
    }

    function showCorrectLine(card,correctRuntime){
      const line=document.createElement("div");
      line.style.fontSize="12px";
      line.style.marginTop="5px";
      line.innerText=`Correct: ${correctRuntime} min`;
      card.appendChild(line);
    }

    /* Move recap overlay to top center, more visible styling */
    function showRoundRecapOverlay(roundCorrect,answeredCount,leftoverBonus,fractionBonus,roundScore){
      const overlay=document.getElementById("round-recap-overlay");
      const title=document.getElementById("round-recap-title");
      const details=document.getElementById("round-recap-details");

      title.innerText=`Round ${currentRoundIndex+1} Recap`;
      details.innerHTML=`
        Correct: <strong>${roundCorrect}</strong> / 5<br>
        Time bonus: <strong>+${leftoverBonus.toFixed(0)}</strong><br>
        Accuracy bonus: <strong>+${fractionBonus.toFixed(0)}</strong><br>
        Round Score: <strong>${roundScore.toFixed(0)}</strong>
      `;
      overlay.style.display="block";
    }

    function nextRoundAfterRecap(){
      document.getElementById("round-recap-overlay").style.display="none";
      document.getElementById("submit-btn").style.display="block";
      startRound();
    }

    /*******************************************************
     * JOKER: REVEAL RELATIVE RUNTIMES
     *******************************************************/
    function useJoker(){
      if(jokerUsed)return;
      jokerUsed=true;
      document.getElementById("joker-btn").style.display="none";

      // play beep
      const snd=document.getElementById("joker-sound");
      snd.currentTime=0;
      snd.play().catch(()=>{});

      const roundMovies=rounds[currentRoundIndex];
      const sorted=[...roundMovies].sort((a,b)=>b.runtime_minutes-a.runtime_minutes);

      // color-coded green from darkest to brightest
      const greenShades=["#003300","#006600","#009900","#00CC00","#00FF00"];
      const originals=[];
      sorted.forEach((m,idx)=>{
        const card=findMovieCard(m["Movie Name"]);
        if(!card)return;
        originals.push({card,bg:card.style.backgroundColor,bc:card.style.borderColor});
        card.style.backgroundColor=greenShades[idx];
        card.style.borderColor=greenShades[idx];
      });

      // revert after 5s
      setTimeout(()=>{
        originals.forEach(o=>{
          o.card.style.backgroundColor="#000";
          o.card.style.borderColor="white";
        });
      },5000);
    }

    /*******************************************************
     * BONUS ROUND
     *******************************************************/
    function startBonusRound(){
      bonusUsed=false;
      bonusTimeLeft=10;
      let pool=shuffle(filteredMovies.slice());
      if(pool.length<5)pool=allMovies.slice();
      bonusMovies=pool.slice(0,5);

      const container=document.getElementById("bonus-floating-container");
      container.innerHTML="";
      bonusMovies.forEach(m=>{
        const card=document.createElement("div");
        card.classList.add("floating-card");
        card.innerText=m["Movie Name"];
        card.addEventListener("click",()=>pickBonusMovie(m,card));
        container.appendChild(card);
      });
      setupBonusTimer();
      document.getElementById("bonus-message").innerText="";
      document.getElementById("bonus-result").innerText="";
    }
    function setupBonusTimer(){
      clearInterval(bonusTimer);
      const box=document.getElementById("bonus-timer-box");
      const val=document.getElementById("bonus-timer-value");
      val.innerText=bonusTimeLeft;
      box.style.color="white";
      box.style.borderColor="#444";

      bonusTimer=setInterval(()=>{
        bonusTimeLeft--;
        val.innerText=bonusTimeLeft;
        if(bonusTimeLeft<=3){
          box.style.color="red";
          box.style.borderColor="red";
        }else if(bonusTimeLeft<=5){
          box.style.color="orange";
          box.style.borderColor="orange";
        }
        if(bonusTimeLeft<=0){
          clearInterval(bonusTimer);
          if(!bonusUsed){
            document.getElementById("bonus-message").innerText="Time's up! No pick made.";
          }
        }
      },1000);
    }
    function pickBonusMovie(chosenMovie,chosenCard){
      if(bonusUsed)return;
      bonusUsed=true;
      clearInterval(bonusTimer);

      let maxRuntime=-1,maxMovie=null;
      bonusMovies.forEach(m=>{
        if(m.runtime_minutes>maxRuntime){
          maxRuntime=m.runtime_minutes;
          maxMovie=m;
        }
      });
      const correct=(chosenMovie.runtime_minutes===maxRuntime);
      chosenCard.classList.add(correct?"correct":"incorrect");
      if(correct){
        totalScore+=1000;
        document.getElementById("bonus-message").innerText="Correct! +1000 points.";
      }else{
        document.getElementById("bonus-message").innerText=`Sorry, it was ${maxMovie["Movie Name"]} (${maxRuntime} min).`;
      }
    }
    function onFinishBonus(){
      document.getElementById("bonus-container").style.display="none";
      showFinalScreen();
    }

    /*******************************************************
     * FINAL SCREEN
     *******************************************************/
    function showFinalScreen(){
      document.getElementById("final-container").style.display="flex";
      const accuracy=(totalCorrect/25)*100;
      const skill=totalAnswered?(totalDifference/totalAnswered):0;
      document.getElementById("final-scores").innerText=`Final Score: ${Math.round(totalScore)}`;

      let breakdownHTML="";
      roundScores.forEach(r=>{
        breakdownHTML+=`
          <div class="breakdown-row">
            Round ${r.roundIndex}: ${r.correct}/5 correct<br>
            Time bonus: +${(r.leftoverBonus||0).toFixed(0)}<br>
            Accuracy bonus: +${(r.fractionBonus||0).toFixed(0)}<br>
            Round Score: ${r.roundScore.toFixed(0)}
          </div><br>
        `;
      });
      breakdownHTML+=`<div class="breakdown-row">
        Overall Accuracy: ${accuracy.toFixed(1)}% | Skill: ${skill.toFixed(1)} min
      </div>`;
      document.getElementById("round-breakdown").innerHTML=breakdownHTML;

      const finalCardsContainer=document.getElementById("final-cards-container");
      finalCardsContainer.innerHTML="";
      rounds.forEach((round,idx)=>{
        const rowDiv=document.createElement("div");
        rowDiv.classList.add("final-round-row");

        const heading=document.createElement("div");
        heading.classList.add("final-round-heading");
        heading.innerText=`Round ${idx+1}`;
        rowDiv.appendChild(heading);

        round.forEach(movie=>{
          const actual=movie.runtime_minutes;
          const assigned=(movie._assignedRuntime!==null)?movie._assignedRuntime:"-";
          const isCorrect=(assigned===actual);
          const card=document.createElement("div");
          card.classList.add("final-card");
          if(assigned!=="-"){
            card.classList.add(isCorrect?"correct":"incorrect");
          }
          card.innerHTML=`
            <div style="font-weight:bold; margin-bottom:5px;">${movie["Movie Name"]}</div>
            <div>Actual: ${movie.Runtime}</div>
            <div>Your Pick: ${assigned==="-"?"-":assigned+" min"}</div>
          `;
          rowDiv.appendChild(card);
        });
        finalCardsContainer.appendChild(rowDiv);
      });
    }

    /*******************************************************
     * SHARE & COPY
     *******************************************************/
    function shareOnTwitter(){
      const accuracy=(totalCorrect/25)*100;
      const skill=totalAnswered?(totalDifference/totalAnswered):0;
      const popcorn=getPopcornString(accuracy);
      const text=`Stump the Buff Recap:
Score: ${Math.round(totalScore)}
Accuracy: ${popcorn} (${accuracy.toFixed(1)}%)
Skill: ${skill.toFixed(1)}
Think you can beat me? Head to oscers.com`;
      const url=`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
      window.open(url,"_blank");
    }
    function copyRecap(){
      const accuracy=(totalCorrect/25)*100;
      const skill=totalAnswered?(totalDifference/totalAnswered):0;
      const popcorn=getPopcornString(accuracy);
      const text=`Stump the Buff Recap:
Score: ${Math.round(totalScore)}
Accuracy: ${popcorn} (${accuracy.toFixed(1)}%)
Skill: ${skill.toFixed(1)}
Think you can beat me? Head to oscers.com`;
      navigator.clipboard.writeText(text).then(()=>{
        alert("Recap copied to clipboard!");
      }).catch(()=>{
        alert("Failed to copy recap. Your browser may not allow clipboard writes.");
      });
    }

    /*******************************************************
     * UTILS
     *******************************************************/
    function fadeOutCards(callback){
      const mc=document.getElementById("movies-container");
      const rc=document.getElementById("runtimes-container");
      mc.style.opacity="1";
      rc.style.opacity="1";
      mc.offsetHeight;
      mc.style.opacity="0";
      rc.style.opacity="0";
      setTimeout(callback,500);
    }
    function fadeInCards(){
      const mc=document.getElementById("movies-container");
      const rc=document.getElementById("runtimes-container");
      mc.style.opacity="0";
      rc.style.opacity="0";
      mc.offsetHeight;
      mc.style.opacity="1";
      rc.style.opacity="1";
    }
    function shuffle(array){
      for(let i=array.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [array[i],array[j]]=[array[j],array[i]];
      }
      return array;
    }
    function getPopcornString(accuracyPercent){
      return renderPopcorn(accuracyPercent).trim();
    }
    function renderPopcorn(accuracyPercent){
      const ratingOutOf5=(accuracyPercent/100)*5;
      const full=Math.floor(ratingOutOf5);
      const frac=ratingOutOf5-full;
      let html="";
      for(let i=0;i<full;i++){
        html+="🍿";
      }
      if(frac>0){
        html+="🍿";
      }
      return html+" ";
    }
    function findMovieCard(name){
      const cards=document.querySelectorAll("#movies-container .movie-card");
      for(let c of cards){
        const t=c.querySelector(".movie-title");
        if(t && t.innerText===name)return c;
      }
      return null;
    }

    // Added function to update game stats.
    function updateGameStatsBox(){
      const statsBox = document.getElementById("this-game-stats");
      statsBox.innerText = `Score: ${Math.round(totalScore)}`;
      if (statsBox.classList.contains("empty")) {
        statsBox.classList.remove("empty");
      }
    }
  </script>
</body>
</html>
