<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stump the Buff - v2.6</title>
  <style>
    /* ---------- GLOBAL / LAYOUT ---------- */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: black;
      color: white;
      font-family: Rockwell, serif;
    }
    .page-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      box-sizing: border-box;
      text-align: center;
    }
    h1, h2, h3, p {
      margin: 0 0 10px 0;
    }
    button {
      cursor: pointer;
    }
    .version-number {
      text-align: center;
      font-size: 10px;
      opacity: 0.7;
      margin-top: 20px;
    }

    /* ---------- BUTTON STYLES ---------- */
    .diff-btn {
      background: #222;
      border: 2px solid #FFD700;
      color: white;
      font-size: 16px;
      padding: 8px 16px;
      margin: 5px;
      transition: background 0.2s, color 0.2s, border-color 0.2s;
    }
    .diff-btn:hover {
      background: #333;
    }
    .diff-btn.active {
      background: #FFD700;
      color: black;
      border-color: #FFD700;
    }
    #begin-btn {
      background: #FFD700;
      color: black;
      border: none;
      font-size: 22px;
      padding: 12px 30px;
      margin-top: 20px;
    }
    #begin-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ---------- MAIN CONTAINERS ---------- */
    #intro-container {
      display: flex;
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
    }
    #game-container,
    #bonus-container,
    #final-container {
      display: none;
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
    }

    /* ---------- INTRO PAGE ---------- */
    #intro-container .intro-rules {
      max-width: 600px;
      font-size: 16px;
      line-height: 1.4;
      margin-bottom: 20px;
      text-align: center;
    }
    .difficulty-box { margin-bottom: 20px; }

    /* ---------- GAME PAGE ---------- */
    #timer-box {
      margin: 10px auto;
      width: 160px;
      height: 160px;
      background-color: #222;
      border-radius: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 64px;
      font-weight: bold;
      color: white;
      border: 2px solid #444;
      transition: all 0.2s ease;
    }
    /* Use grid for movie cards: 3 columns for 5 cards (3 on first row, 2 on second) */
    #movies-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
      width: 100%;
    }
    /* Runtimes still in flex */
    #runtimes-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .movie-card {
      width: 180px;
      border: 2px solid white;
      margin: 5px auto;
      padding: 10px;
      background-color: #000;
      border-radius: 25px; /* more rounded */
      text-align: center;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: background-color 0.2s, border-color 0.2s;
    }
    .movie-title {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 32px; /* doubled */
    }
    /* highlight when a runtime is placed */
    .placed {
      border-color: #FFD700 !important;
      background-color: #111;
    }
    .runtime-card {
      width: 100px;
      height: 60px;
      border-radius: 30px;
      background-color: #FFD700;
      color: black;
      font-weight: bold;
      border: 2px solid #FFD700;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 5px;
      cursor: grab;
      animation: float-run 3s ease-in-out infinite alternate;
    }
    @keyframes float-run {
      0% { transform: translateY(0); }
      100% { transform: translateY(-5px); }
    }
    .correct {
      background-color: #003300 !important;
      border-color: #00FF00 !important;
      animation: pulse-green 0.5s;
    }
    .incorrect {
      background-color: #330000 !important;
      border-color: #FF0000 !important;
      animation: shake-red 0.5s;
    }
    @keyframes pulse-green {
      50% { transform: scale(1.05); }
    }
    @keyframes shake-red {
      20% { transform: translateX(-3px); }
      40% { transform: translateX(3px); }
      60% { transform: translateX(-3px); }
      80% { transform: translateX(3px); }
    }
    .stats-box {
      border: 1px solid #666;
      padding: 10px;
      margin: 10px auto;
      width: fit-content;
      min-width: 200px;
    }
    .stats-box.empty { display: none; }

    #joker-btn {
      display: inline-block;
      width: 80px;
      height: 80px;
      border-radius: 40px;
      font-size: 32px;
      background: #222;
      border: 2px solid #FFD700;
      color: white;
      margin: 10px auto;
    }
    #joker-btn:hover {
      background: #333;
    }
    .glow-anim {
      animation: glow 2s ease-in-out infinite alternate;
    }
    @keyframes glow {
      0% { box-shadow: 0 0 5px #FFD700; }
      100% { box-shadow: 0 0 20px #FFD700; }
    }

    /* ---------- BONUS ROUND (GRID) ---------- */
    #bonus-container {
      text-align: center;
    }
    #bonus-timer-box {
      margin: 10px auto;
      width: 120px;
      height: 120px;
      background-color: #222;
      border-radius: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      font-weight: bold;
      color: white;
      border: 2px solid #444;
      transition: all 0.2s ease;
      margin-bottom: 20px;
    }
    /* Use grid to ensure bonus cards don't overlap */
    #bonus-floating-container {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      width: 100%;
      max-width: 800px;
      margin: 0 auto 20px auto;
    }
    .floating-card {
      /* No absolute positioning now */
      width: 120px;
      height: 120px;
      border: 2px solid white;
      border-radius: 60px;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      padding: 5px;
    }

    /* ---------- FINAL PAGE ---------- */
    #final-container {
      text-align: center;
    }
    #final-scores {
      margin-bottom: 20px;
      font-size: 28px;
      font-weight: bold;
    }
    #details-toggle {
      margin-bottom: 10px;
      padding: 8px 16px;
      font-size: 14px;
      background: #222;
      color: white;
      border: 2px solid #FFD700;
      cursor: pointer;
    }
    #details-container {
      display: none;
      margin: 10px 0;
    }
    .breakdown-row {
      margin-bottom: 10px;
      text-align: center;
    }
    .final-round-row {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .final-round-heading {
      font-size: 32px; /* Bigger round names */
      text-align: center;
      width: 100%;
      font-weight: bold;
      margin-bottom: 8px;
    }
    .final-card {
      border-radius: 10px;
      border: 2px solid #666;
      padding: 10px;
      text-align: center;
      width: 140px;
      background: #000;
      margin: 5px;
    }
    .final-card.correct {
      background-color: #003300;
      border-color: #0f0;
    }
    .final-card.incorrect {
      background-color: #330000;
      border-color: #f00;
    }

    /* ---------- LARGER SUBMIT BUTTON ---------- */
    #submit-btn {
      font-size: 22px;
      padding: 12px 30px;
      margin: 20px auto;
      background: #FFD700;
      color: black;
      border: none;
    }
    #submit-btn:hover {
      background: #FFC700;
    }

    #share-twitter-btn, #copy-recap-btn, #play-again-btn {
      display: inline-block;
      margin: 10px 8px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      background: #222;
      color: white;
      border: 2px solid #FFD700;
    }
  </style>
</head>
<body>
  <!-- AUDIO FOR JOKER -->
  <audio id="joker-sound" preload="auto">
    <source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA=" type="audio/wav">
  </audio>

  <!-- INTRO SCREEN -->
  <div id="intro-container" class="page-container">
    <h1>Stump the Buff</h1>
    <div class="intro-rules">
      <p>In this game, you'll be given 5 movies each round.</p>
      <p>Drag the runtime card to the movie you think it belongs to.</p>
      <p>You have a limited time each round and can submit early.</p>
      <p>Use your <strong>Joker</strong> once at the start of the round.</p>
    </div>
    <div class="difficulty-box">
      <label style="font-size:16px; margin-right:10px;">Difficulty:</label>
      <button class="diff-btn" data-difficulty="easy" id="easy-btn">Easy</button>
      <button class="diff-btn" data-difficulty="medium" id="medium-btn">Medium</button>
      <button class="diff-btn" data-difficulty="hard" id="hard-btn">Hard</button>
    </div>
    <button id="begin-btn" disabled>Begin</button>
    <div class="version-number">v2.6</div>
  </div>

  <!-- GAME SCREEN -->
  <div id="game-container" class="page-container">
    <div id="timer-box">
      <span id="timer-value">20</span>
    </div>
    <!-- Movie cards arranged in grid (3/2) -->
    <div id="movies-container" class="cards-container"></div>
    <!-- Runtimes appear above, then Joker underneath the movie cards -->
    <div id="runtimes-container" class="cards-container"></div>
    <div class="center">
      <button id="joker-btn" class="glow-anim" title="Use Joker (once)">ðŸ¤¡</button>
    </div>
    <div id="this-game-stats" class="stats-box empty"></div>
    <button id="submit-btn">Submit</button>
  </div>

  <!-- BONUS ROUND (Grid Layout) -->
  <div id="bonus-container" class="page-container">
    <div id="bonus-timer-box">
      <span id="bonus-timer-value">10</span>
    </div>
    <h3 id="bonus-message"></h3>
    <div id="bonus-floating-container" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; width:100%; max-width:800px; margin:0 auto 20px auto;"></div>
    <div id="bonus-result"></div>
    <button id="bonus-continue-btn">Continue</button>
  </div>

  <!-- FINAL SCREEN -->
  <div id="final-container" class="page-container">
    <div id="final-scores"></div>
    <button id="details-toggle">Show/Hide Details</button>
    <div id="details-container">
      <div id="round-breakdown"></div>
      <div id="final-cards-container"></div>
    </div>
    <div>
      <button id="share-twitter-btn">Share on Twitter</button>
      <button id="copy-recap-btn">Copy Recap</button>
      <button id="play-again-btn">Play Again?</button>
    </div>
  </div>

  <script>
    /*******************************************************
     * GLOBAL STATE & CONFIG
     *******************************************************/
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vToIbm5XR9mtqOXHYzpF0jIXhGY9WI9m-QQak2KsZFB6CGVnRVRCPL3V6zFVbT6e_jLyGQM1e5XPjcX/pub?gid=131639577&single=true&output=csv";
    let difficulty;
    let allMovies = [];
    let filteredMovies = [];
    const TIMERS = {
      easy:   [30, 30, 30, 30, 30],
      medium: [30, 25, 20, 15, 15],
      hard:   [20, 18, 15, 12, 10]
    };
    let roundTimers = [];
    let rounds = [];
    let currentRoundIndex = 0;

    let totalCorrect = 0;
    let totalDifference = 0;
    let totalAnswered = 0;
    let totalScore = 0;
    let roundScores = [];

    let jokerUsed = false;
    // We no longer disable Joker on drag start
    let timeLeft = 20;
    let roundTimer = null;
    let canDrag = false;

    // Bonus
    let bonusMovies = [];
    let bonusUsed = false;
    let bonusTimer = null;
    let bonusTimeLeft = 10;

    /*******************************************************
     * PAGE LOAD & CSV FETCH/INIT
     *******************************************************/
    document.addEventListener("DOMContentLoaded", async () => {
      // Difficulty button highlighting
      document.getElementById("easy-btn").addEventListener("click", () => setDifficulty("easy"));
      document.getElementById("medium-btn").addEventListener("click", () => setDifficulty("medium"));
      document.getElementById("hard-btn").addEventListener("click", () => setDifficulty("hard"));

      const beginBtn = document.getElementById("begin-btn");
      beginBtn.disabled = true;
      beginBtn.innerText = "Loading...";
      try {
        await fetchCSV();
        beginBtn.disabled = false;
        beginBtn.innerText = "Begin";
      } catch(e) {
        console.error("Error fetching CSV:", e);
        beginBtn.innerText = "Error loading data";
      }

      beginBtn.addEventListener("click", onBeginGame);

      // Joker
      document.getElementById("joker-btn").addEventListener("click", () => {
        // Only allow Joker if it hasn't been used
        if (!jokerUsed) useJoker();
      });

      // Submit
      document.getElementById("submit-btn").addEventListener("click", onSubmitRound);

      // Bonus
      document.getElementById("bonus-continue-btn").addEventListener("click", onFinishBonus);

      // Final
      document.getElementById("share-twitter-btn").addEventListener("click", shareOnTwitter);
      document.getElementById("copy-recap-btn").addEventListener("click", copyRecap);
      document.getElementById("play-again-btn").addEventListener("click", () => {
        document.getElementById("final-container").style.display = "none";
        document.getElementById("intro-container").style.display = "flex";
      });

      // Toggle final details
      document.getElementById("details-toggle").addEventListener("click", () => {
        const det = document.getElementById("details-container");
        det.style.display = (det.style.display === "none" ? "block" : "none");
      });
    });

    /*******************************************************
     * DIFFICULTY UI
     *******************************************************/
    function setDifficulty(diff) {
      difficulty = diff;
      // Highlight the chosen button
      ["easy-btn", "medium-btn", "hard-btn"].forEach(id => {
        document.getElementById(id).classList.remove("active");
      });
      document.getElementById(`${diff}-btn`).classList.add("active");
    }

    /*******************************************************
     * FETCH CSV
     *******************************************************/
    async function fetchCSV() {
      const resp = await fetch(csvUrl);
      const data = await resp.text();
      parseCSV(data);
    }
    function parseCSV(csvData) {
      const lines = csvData.trim().split(/\r?\n/);
      const headers = lines[0].split(",");
      const colMovieName = headers.indexOf("Movie Name");
      const colRuntimeMin = headers.indexOf("runtime_minutes");
      const colRuntime = headers.indexOf("Runtime");
      const colVotesRank = headers.indexOf("Votes Percent Rank");

      for (let i = 1; i < lines.length; i++) {
        const rowCells = lines[i].split(",");
        if (rowCells.length < 4) continue;
        let movie = {};
        movie["Movie Name"] = rowCells[colMovieName]?.trim() || "";
        movie.runtime_minutes = parseInt(rowCells[colRuntimeMin] || "0", 10);
        movie.Runtime = rowCells[colRuntime] || "";
        movie._rank = parseFloat(rowCells[colVotesRank] || "0");
        movie._assignedRuntime = null;
        allMovies.push(movie);
      }
    }

    /*******************************************************
     * BEGIN GAME
     *******************************************************/
    function onBeginGame() {
      if (!difficulty) {
        difficulty = "easy"; // default
      }
      document.getElementById("intro-container").style.display = "none";
      document.getElementById("game-container").style.display = "flex";
      setupGame();
    }
    function setupGame() {
      currentRoundIndex = 0;
      totalCorrect = 0;
      totalDifference = 0;
      totalAnswered = 0;
      totalScore = 0;
      roundScores = [];
      jokerUsed = false;
      bonusUsed = false;
      document.getElementById("bonus-container").style.display = "none";
      document.getElementById("final-container").style.display = "none";

      filterByDifficulty();
      if (filteredMovies.length < 25) {
        filteredMovies = allMovies.slice();
      }
      roundTimers = TIMERS[difficulty] || [20,20,20,20,20];
      buildRounds();
      startRound();
    }
    function filterByDifficulty() {
      if (!difficulty) return;
      if (difficulty === "easy") {
        filteredMovies = allMovies.filter(m => m._rank > 0.75);
      } else if (difficulty === "medium") {
        filteredMovies = allMovies.filter(m => m._rank >= 0.5 && m._rank <= 0.75);
      } else {
        filteredMovies = allMovies.filter(m => m._rank < 0.5);
      }
    }
    function buildRounds() {
      rounds = [];
      const pool = shuffle(filteredMovies.slice());
      if (pool.length < 25) {
        for (let i = 0; i < 5; i++) {
          rounds.push(pool.slice(i*5, i*5+5));
        }
      } else {
        const selected = pool.slice(0,25);
        for (let i = 0; i < 5; i++) {
          rounds.push(selected.slice(i*5, (i+1)*5));
        }
      }
    }

    /*******************************************************
     * ROUND LOGIC
     *******************************************************/
    function startRound() {
      if (currentRoundIndex >= 5) {
        document.getElementById("game-container").style.display = "none";
        document.getElementById("bonus-container").style.display = "flex";
        startBonusRound();
        return;
      }
      fadeOutCards(renderRound);
    }
    function renderRound() {
      const roundMovies = rounds[currentRoundIndex];
      const moviesContainer = document.getElementById("movies-container");
      const runtimesContainer = document.getElementById("runtimes-container");

      timeLeft = roundTimers[currentRoundIndex] || 20;
      setupTimer();
      updateGameStatsBox();

      // Clear containers
      moviesContainer.innerHTML = "";
      runtimesContainer.innerHTML = "";

      // Joker remains available until round submission (we no longer disable it on drag)
      document.getElementById("joker-btn").style.display = jokerUsed ? "none" : "inline-block";

      // Create movie cards
      roundMovies.forEach(m => {
        const card = document.createElement("div");
        card.classList.add("movie-card");
        card.setAttribute("data-correct", m.runtime_minutes);
        card.innerHTML = `<div class="movie-title">${m["Movie Name"]}</div>`;
        card.addEventListener("dragover", e => { if (canDrag) e.preventDefault(); });
        card.addEventListener("drop", e => dropHandler(e, m, card));
        moviesContainer.appendChild(card);
      });

      // Create runtime cards
      const roundRuntimes = roundMovies.map((m, i) => ({
        runtime: m.Runtime,
        runtime_minutes: m.runtime_minutes,
        uniqueId: `rt-${currentRoundIndex}-${i}`
      }));
      shuffle(roundRuntimes);
      roundRuntimes.forEach(rt => {
        const rc = document.createElement("div");
        rc.classList.add("runtime-card");
        rc.setAttribute("data-unique", rt.uniqueId);
        rc.setAttribute("data-runtime", rt.runtime_minutes.toString());
        rc.setAttribute("draggable", "true");
        rc.innerText = rt.runtime;
        rc.addEventListener("dragstart", e => {
          if (!canDrag) { e.preventDefault(); return; }
          // We no longer disable Joker on drag start
          e.dataTransfer.setData("text/plain", rt.uniqueId);
        });
        runtimesContainer.appendChild(rc);
      });

      fadeInCards();
      canDrag = true;
    }

    function setupTimer() {
      clearInterval(roundTimer);
      const timerBox = document.getElementById("timer-box");
      const timerVal = document.getElementById("timer-value");
      timerVal.innerText = timeLeft;
      timerBox.style.color = "white";
      timerBox.style.borderColor = "#444";

      roundTimer = setInterval(() => {
        timeLeft--;
        timerVal.innerText = timeLeft;
        if (timeLeft <= 3) {
          timerBox.style.color = "red";
          timerBox.style.borderColor = "red";
        } else if (timeLeft <= 5) {
          timerBox.style.color = "orange";
          timerBox.style.borderColor = "orange";
        } else if (timeLeft <= 10) {
          timerBox.style.color = "yellow";
          timerBox.style.borderColor = "yellow";
        } else {
          timerBox.style.color = "white";
          timerBox.style.borderColor = "#444";
        }
        if (timeLeft <= 0) {
          clearInterval(roundTimer);
          onSubmitRound();
        }
      }, 1000);
    }

    /*******************************************************
     * DRAG & DROP
     *******************************************************/
    function dropHandler(e, movieObj, movieCard) {
      if (!canDrag) return;
      e.preventDefault();
      const uniqueId = e.dataTransfer.getData("text/plain");
      const allRuntimeCards = document.querySelectorAll(".runtime-card");
      let draggedCard = null;
      for (let c of allRuntimeCards) {
        if (c.getAttribute("data-unique") === uniqueId) {
          draggedCard = c;
          break;
        }
      }
      if (!draggedCard) return;
      const rc = document.getElementById("runtimes-container");
      const existing = movieCard.querySelector(".runtime-card");
      if (existing) {
        rc.appendChild(existing);
      }
      movieCard.appendChild(draggedCard);
      movieCard.classList.add("placed");
      movieObj._assignedRuntime = parseInt(draggedCard.getAttribute("data-runtime"), 10);
    }

    /*******************************************************
     * SUBMIT ROUND & SCORING
     *******************************************************/
    function onSubmitRound() {
      clearInterval(roundTimer);
      canDrag = false;
      document.getElementById("submit-btn").style.display = "none";

      const roundMovies = rounds[currentRoundIndex];
      let roundCorrect = 0;
      let roundDiff = 0;
      let answeredCount = 0;
      let sumActual = 0;

      const movieCards = document.getElementById("movies-container").children;
      for (let i = 0; i < movieCards.length; i++) {
        const card = movieCards[i];
        const correctRuntime = parseInt(card.getAttribute("data-correct"), 10);
        sumActual += correctRuntime;
        const assigned = card.querySelector(".runtime-card");
        if (assigned) {
          answeredCount++;
          const userRuntime = parseInt(assigned.getAttribute("data-runtime"), 10);
          if (userRuntime === correctRuntime) {
            roundCorrect++;
            card.classList.add("correct");
          } else {
            card.classList.add("incorrect");
            const correctLine = document.createElement("div");
            correctLine.style.fontSize = "12px";
            correctLine.style.marginTop = "5px";
            correctLine.innerText = `Correct: ${correctRuntime} min`;
            card.appendChild(correctLine);
          }
        } else {
          // No runtime assigned
          card.classList.add("incorrect");
          const correctLine 
